name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install latest UPX
        run: |
          set -euo pipefail

          asset_url=$(
            python3 - <<'PY'
            import json
            import sys
            import urllib.request

            api_url = "https://api.github.com/repos/upx/upx/releases/latest"
            try:
                with urllib.request.urlopen(api_url) as resp:
                    data = json.load(resp)
                for asset in data.get("assets", []):
                    name = asset.get("name", "")
                    if "amd64_linux" in name and name.endswith(".tar.xz"):
                        print(asset["browser_download_url"])
                        sys.exit(0)
            except Exception as exc:
                print(f"failed to query latest UPX release: {exc}", file=sys.stderr)
            sys.exit(0)
            PY
          )

          if [[ -n "${asset_url}" ]]; then
            temp_dir=$(mktemp -d)
            curl -sSL "$asset_url" -o "${temp_dir}/upx.tar.xz"
            tar -xJf "${temp_dir}/upx.tar.xz" -C "${temp_dir}"
            upx_dir=$(find "${temp_dir}" -maxdepth 1 -type d -name "upx-*" | head -n 1)
            sudo install -m 0755 "${upx_dir}/upx" /usr/local/bin/upx
            upx -V
          else
            echo "Unable to find amd64_linux UPX asset in latest release, falling back to APT package"
            sudo apt-get update
            sudo apt-get install -y upx || sudo apt-get install -y upx-ucl
            upx -V
          fi

      - name: Build cross-platform binaries
        env:
          CGO_ENABLED: 0
        run: |
          set -euo pipefail
          rm -rf bin
          mkdir -p bin

          executable_name="bin/secDNS"

          # Available platform list: https://golang.org/doc/install/source#environment
          platforms=(
            "aix/ppc64"
            # "android/386"
            # "android/amd64"
            # "android/arm"
            "android/arm64"
            "darwin/amd64"
            "darwin/arm64"
            "dragonfly/amd64"
            "freebsd/386"
            "freebsd/amd64"
            "freebsd/arm"
            "freebsd/arm64"
            "freebsd/riscv64"
            "illumos/amd64"
            "linux/386"
            "linux/amd64"
            "linux/arm"
            "linux/arm64"
            "linux/loong64"
            "linux/mips"
            "linux/mips64"
            "linux/mips64le"
            "linux/mipsle"
            "linux/ppc64"
            "linux/ppc64le"
            "linux/riscv64"
            "linux/s390x"
            "netbsd/386"
            "netbsd/amd64"
            "netbsd/arm"
            "netbsd/arm64"
            "openbsd/386"
            "openbsd/amd64"
            "openbsd/arm"
            "openbsd/arm64"
            "openbsd/ppc64"
            "openbsd/riscv64"
            # "openbsd/mips64"
            "plan9/386"
            "plan9/amd64"
            "plan9/arm"
            "solaris/amd64"
            "windows/386"
            "windows/amd64"
            "windows/arm64"
            "windows/arm"
          )

          for platform in "${platforms[@]}"; do
            IFS='/' read -r GOOS GOARCH <<< "${platform}"
            output_name="${executable_name}-${GOOS}-${GOARCH}"
            if [[ "${GOOS}" == "windows" ]]; then
              output_name+=".exe"
            fi

            echo "Building ${output_name}"
            env GOOS="${GOOS}" GOARCH="${GOARCH}" go build -ldflags="-s -w" -o "${output_name}"
            if ! upx --best --ultra-brute "${output_name}"; then
              echo "UPX skipped for ${output_name} (unsupported format?)"
            fi
          done

      - name: Prepare release notes
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          cat > release_notes.md <<EOF
          ## Downloads
          - Windows: download \`secDNS-windows-amd64.exe\` (64-bit) or \`secDNS-windows-386.exe\` (32-bit); Arm builds: \`secDNS-windows-arm64.exe\` and \`secDNS-windows-arm.exe\`.
          - macOS: download \`secDNS-darwin-arm64\` (Apple silicon) or \`secDNS-darwin-amd64\` (Intel).
          - Linux: download \`secDNS-linux-amd64\` (64-bit), \`secDNS-linux-386\` (32-bit), \`secDNS-linux-arm64\` (modern Arm boards), or \`secDNS-linux-arm\` (older Arm boards).
          - Other platforms: additional builds for BSD, Solaris, AIX, and Plan9 are attached below.

          ## Usage
          - Make the downloaded binary executable when needed (e.g. \`chmod +x ./secDNS-darwin-arm64\` on macOS/Linux) and run from your terminal; append \`--help\` to see flags.
          - Example configuration: [config.json](https://github.com/zhouchenh/secDNS/blob/${TAG_NAME}/config.json). It expects a domain list file such as [accelerated-domains.china.conf](https://github.com/felixonmars/dnsmasq-china-list/blob/master/accelerated-domains.china.conf) placed alongside the config.

          ## What's new
          - Full change log for this release: https://github.com/zhouchenh/secDNS/blob/${TAG_NAME}/docs/version_history.md
          EOF

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body_path: release_notes.md
          files: bin/secDNS-*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
