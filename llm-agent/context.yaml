# secDNS Project Knowledge Base
# Updated for downstream LLM agents
# Last Updated: 2025-11-29

metadata:
  project_name: secDNS
  version: 1.3.0
  release_date: 2025-11-29
  language: Go
  go_version: "1.23"
  toolchain: "1.24.7"
  license: AGPLv3
  branch: claude/full-project-scan-011CUtLhKHKTYJHozka1zpVg
  go_files: 98
  test_files: 27
  doc_files: 27

project_purpose:
  summary: "DNS resolver/proxy that routes queries through configurable upstream resolvers to avoid censorship and poisoning."
  use_cases:
    - Bypass ISP DNS spoofing/censorship
    - Route specific domains to chosen resolvers
    - Provide secure transport (DoH/DoT/TCP) with caching and filtering
    - Offer HTTP automation endpoint for DNS resolution

key_features:
  listeners:
    - dnsServer: UDP/TCP DNS listener (default port 53), supports EDNS0, TCP fallback; no DoT termination.
    - httpAPIServer: HTTP GET/POST (form or JSON) `/resolve` endpoint returning JSON answers; available v1.2.1+.
  resolvers:
    - nameServer: Plain/DoT TCP/UDP resolver with SOCKS5, TLS verification, EDNS0/TCP fallback.
    - doh: DNS-over-HTTPS with URL resolution helper, SOCKS5, ECS, and timeout controls.
    - cache: High-performance cache with LRU, TTL overrides/jitter, negative caching, stale-while-revalidate, prefetch, warmup queries, EDNS cache-control hints, per-domain stats.
    - recursive: Recursive resolver with root-hint bootstrap, adaptive root ranking, singleflight, referral/glue handling, DS→DNSKEY chain validation, NSEC/NSEC3 coverage, AD gating, SOCKS5/bind-address support, and ECS passthrough/add/override/strip with end-to-end propagation.
    - ecs: Wrapper resolver to apply ECS policy (passthrough/add/override/strip) before delegating, so cache/recursive can be shared across ECS variants. (v1.3.0+)
    - dns64: AAAA synthesis with IPv6 prefix config; optional ignoreExistingAAAA flag.
    - composition: sequence (ordered failover) and concurrentNameServerList (fastest response wins).
    - response generators: address, alias, noAnswer, notExist.
    - filters: filterOutA, filterOutAAAA, filterOutAIfAAAAPresents, filterOutAAAAIfAPresents.
  rules:
    - dnsmasqConf provider (dnsmasq-format routing files, closes files, warns on duplicates).
    - collection provider (JSON name→resolver pairs).
  architecture: Descriptor-based plugin system; features auto-register via `internal/features`.

configuration:
  format: JSON parsed through descriptor system (go-descriptor).
  navigation: README.md → docs/configuration.md → docs/listeners.md / docs/resolvers.md for component details.
  cache_numeric_fields: Accept literal numbers or numeric strings; defaults documented in `docs/resolvers/cache.md`.
    fields: size, cleanupInterval, minTTL, maxTTL, defaultTTL, fallbackTTL, negativeTTL, nxDomainTTL, noDataTTL, prefetchThreshold, prefetchPercent, staleDuration, warmupRefreshInterval, warmupTimeout.
    behavior: Negative responses prefer upstream SOA minimum TTL when present; otherwise use configured/default negativeTTL.
  boolean_string_fields: cache `serveStale`/`cacheControlEnabled` and dns64 `ignoreExistingAAAA` accept booleans or "true"/"false".
  required: At least one listener and one resolver; `defaultResolver` required.
  env: CONFIG_DIR overrides config search root for relative paths.

architecture_details:
  listeners:
    dnsServer: internal/listeners/servers/dns/server/types.go (UDP/TCP, EDNS0, TCP fallback).
    httpAPIServer: internal/listeners/servers/http/server/types.go (GET/POST form/json, JSON responses, version range v1.2.1+).
  resolvers:
    paths:
      - internal/upstream/resolvers/nameserver/types.go
      - internal/upstream/resolvers/doh/types.go
      - internal/upstream/resolvers/cache/types.go
      - internal/upstream/resolvers/recursive/types.go
      - internal/upstream/resolvers/dns64/types.go
      - internal/upstream/resolvers/sequence/types.go
      - internal/upstream/resolvers/concurrent/nameserver/list/types.go
      - internal/upstream/resolvers/address/types.go
      - internal/upstream/resolvers/alias/types.go
      - internal/upstream/resolvers/no/answer/resolver/types.go
      - internal/upstream/resolvers/not/exist/resolver/types.go
      - internal/upstream/resolvers/filter/out/a/types.go
      - internal/upstream/resolvers/filter/out/aaaa/types.go
      - internal/upstream/resolvers/filter/out/a/if/aaaa/presents/types.go
      - internal/upstream/resolvers/filter/out/aaaa/if/a/presents/types.go
    interface: pkg/upstream/resolver/interfaces.go
  rule_providers:
    - internal/rules/providers/dnsmasq/conf/types.go
    - internal/rules/providers/collection/types.go

recent_work:
  - Added HTTP API listener with GET/POST form+JSON handling and docs (v1.2.1).
  - Expanded cache resolver (prefetch, warmup, stale-while-revalidate, TTL jitter, cache-control hints, per-domain stats) and aligned descriptors to accept numeric strings and numbers; docs updated.
  - Verified version history and docs crosslinks; README now points to configuration → listeners/resolvers.
  - Added unit tests across resolvers (alias, sequence, dns64, doh, nameserver, filter variants, noAnswer, notExist), cache warmup/prefetch, HTTP API, and rule provider descriptors.
  - Converted llm-agent common-issues JSON into numbered Markdown todos for triage.
  - Recursive resolver hardened: adds DS→DNSKEY chain validation to root anchors, NSEC/NSEC3 coverage for NXDOMAIN/NODATA, AD gating with strict/permissive policies, SOCKS5/bind-address support, ECS propagation with add/override/strip, and unit tests with signed fixtures.
  - DNSSEC validation now enforces RRSIG timing, verifies DS/DNSKEY chains, and checks NSEC/NSEC3 coverage (strict vs permissive). Default remains permissive; strict fails on validation errors.
  - Added ECS wrapper resolver (add/override/strip) to reuse caches across ECS variants and documented resolver ordering; resolver list alphabetized.

testing:
  status: "`go test -mod=readonly ./...` passing (2025-11-29)."
  coverage: Unit-heavy for cache/resolvers/rule providers; limited integration/e2e coverage.
  notes: Core/pkg packages still mostly lack tests; long-running cache tests are short (<1s) after recent changes.

documentation:
  key_files:
    - README.md (overview + navigation)
    - docs/configuration.md (global config schema)
    - docs/listeners.md + docs/listeners/http_api_server.md
    - docs/resolvers.md + resolver-specific docs (cache, doh, nameserver, dns64, filters, etc.)
    - docs/rules.md + docs/rules/collection.md + docs/rules/dnsmasq_conf.md
    - docs/version_history.md (through v1.3.0 dated 2025.11.29)
  notes: Cache docs clarify numeric-string acceptance and SOA TTL preference for negative caching.

current_state:
  repo_status: go test clean; working tree has untracked artifacts (.DS_Store, .idea/, binaries, code-inspection-result-20251127/).
  binaries: prebuilt secDNS-* artifacts at repo root.
  config_samples: config.json/config-test*.json in root.
  tooling: go.mod uses module github.com/zhouchenh/secDNS; vendored deps present.

known_gaps:
  - Limited integration/e2e tests for full listener→resolver chains and HTTP API flows; recursive resolver lacks on-wire integration coverage.
  - pkg-level interfaces lack unit coverage.
  - code-inspection-result-20251127/ remains as backlog reference; ensure warnings stay resolved when editing.
  - llm-agent/common-issues/todo/ contains triage notes; move to done/ after fixes.

llm_agent_notes:
  - Register new listeners/resolvers/providers in internal/features/features.go.
  - Follow descriptor pattern; numeric configs should accept number or numeric string with sane defaults.
  - Keep docs consistent with existing style and navigation paths.
  - Preserve AGPLv3 headers where applicable; avoid deleting user edits.
  - Default test command: `go test -mod=readonly ./...`.

contacts:
  repo: https://github.com/zhouchenh/secDNS (inferred)
  license: AGPLv3
