# secDNS Project Knowledge Base
# Updated for downstream LLM agents
# Last Updated: 2025-12-03

metadata:
  project_name: secDNS
  version: 1.3.7
  release_date: 2025-12-06
  language: Go
  go_version: "1.23"
  toolchain: "1.24.7"
  license: AGPLv3
  branch: master
  go_files: 100
  test_files: 28
  doc_files: 26

project_purpose:
  summary: "DNS resolver/proxy that routes queries through configurable upstream resolvers to avoid censorship and poisoning."
  use_cases:
    - Bypass ISP DNS spoofing/censorship
    - Route specific domains to chosen resolvers
    - Provide secure transport (DoH/DoT/TCP) with caching and filtering
    - Offer HTTP automation endpoint for DNS resolution

key_features:
  listeners:
    - dnsServer: UDP/TCP DNS listener (default port 53), supports EDNS0, TCP fallback; no DoT termination.
    - httpAPIServer: HTTP GET/POST (form or JSON) `/resolve` endpoint returning JSON answers; available v1.2.1+. Raw/simple response options in v1.3.1+.
  resolvers:
    - nameServer: Plain/DoT TCP/UDP resolver with SOCKS5, TLS verification, EDNS0/TCP fallback.
    - doh: DNS-over-HTTPS with URL resolution helper, SOCKS5, ECS, and timeout controls.
    - cache: High-performance cache with LRU, TTL overrides/jitter, negative caching, stale-while-revalidate, prefetch, EDNS cache-control hints, per-domain stats.
    - recursive: Recursive resolver with root-hint bootstrap (defaults to embedded hints if omitted), adaptive root ranking, singleflight, referral/glue handling, DS→DNSKEY chain validation, NSEC/NSEC3 coverage, AD gating, SOCKS5/bind-address support, and ECS passthrough/add/override/strip with end-to-end propagation (root, referrals/glue, CNAME, DS/DNSKEY). Falls back to TCP when UDP exchange fails.
    - ecs: Wrapper resolver to apply ECS policy (passthrough/add/override/strip) before delegating, so cache/recursive can be shared across ECS variants. (v1.3.0+)
    - dns64: AAAA synthesis with IPv6 prefix config; optional ignoreExistingAAAA flag.
    - composition: sequence (ordered failover) and concurrentNameServerList (fastest response wins).
    - response generators: address, alias, noAnswer, notExist.
    - filters: filterOutA, filterOutAAAA, filterOutAIfAAAAPresents, filterOutAAAAIfAPresents.
  rules:
    - dnsmasqConf provider (dnsmasq-format routing files, closes files, ignores duplicates after the first match).
    - collection provider (JSON name→resolver pairs).
  architecture: Descriptor-based plugin system; features auto-register via `internal/features`.

configuration:
  format: JSON parsed through descriptor system (go-descriptor).
  navigation: README.md → docs/configuration.md → docs/listeners.md / docs/resolvers.md for component details.
  resolver_references: Fields named `resolver` accept either an inline ResolverObject or a named resolver string (cache, ecs, dns64, defaultResolver, listener downstreams).
  cache_numeric_fields: Accept literal numbers or numeric strings; defaults documented in `docs/resolvers/cache.md`.
    fields: size, cleanupInterval, minTTL, maxTTL, defaultTTL, fallbackTTL, negativeTTL, nxDomainTTL, noDataTTL, prefetchThreshold, prefetchPercent, staleDuration.
    behavior: Negative responses prefer upstream SOA minimum TTL when present; otherwise use configured/default negativeTTL.
  boolean_string_fields: cache `serveStale`/`cacheControlEnabled` and dns64 `ignoreExistingAAAA` accept booleans or "true"/"false".
  required: At least one listener and one resolver; `defaultResolver` required.
  env: CONFIG_DIR overrides config search root for relative paths.

architecture_details:
  listeners:
    dnsServer: internal/listeners/servers/dns/server/types.go (UDP/TCP, EDNS0, TCP fallback).
    httpAPIServer: internal/listeners/servers/http/api/server/types.go (GET/POST form/json, JSON responses, version range v1.2.1+).
  resolvers:
    paths:
      - internal/upstream/resolvers/nameserver/types.go
      - internal/upstream/resolvers/doh/types.go
      - internal/upstream/resolvers/cache/types.go
      - internal/upstream/resolvers/recursive/types.go
      - internal/upstream/resolvers/dns64/types.go
      - internal/upstream/resolvers/sequence/types.go
      - internal/upstream/resolvers/concurrent/nameserver/list/types.go
      - internal/upstream/resolvers/address/types.go
      - internal/upstream/resolvers/alias/types.go
      - internal/upstream/resolvers/no/answer/resolver/types.go
      - internal/upstream/resolvers/not/exist/resolver/types.go
      - internal/upstream/resolvers/filter/out/a/types.go
      - internal/upstream/resolvers/filter/out/aaaa/types.go
      - internal/upstream/resolvers/filter/out/a/if/aaaa/presents/types.go
      - internal/upstream/resolvers/filter/out/aaaa/if/a/presents/types.go
    interface: pkg/upstream/resolver/interfaces.go
  rule_providers:
    - internal/rules/providers/dnsmasq/conf/types.go
    - internal/rules/providers/collection/types.go

recent_work:
  - Added upstream request limiting for the cache resolver (maxConcurrentRequests/maxQueuedRequests/requestQueueTimeout) to throttle miss/prefetch bursts; updated docs, tests, and prod config defaults.
  - Removed cache warmupQueries option; cache now builds state from live traffic/prefetch without startup warmers.
  - Moved HTTP API server implementation under internal/listeners/servers/http/api/server to match listener layout.
  - Added HTTP API listener with GET/POST form+JSON handling and docs (v1.2.1).
  - Expanded cache resolver (prefetch, stale-while-revalidate, TTL jitter, cache-control hints, per-domain stats) and aligned descriptors to accept numeric strings and numbers; ECS cache keying now uses response scope, falling back to source prefix when scope=0.
  - Cache resolver docs now clarify `resolver` accepts a named resolver string or inline ResolverObject (same pattern as ecs/dns64).
  - Verified version history and docs crosslinks; README now points to configuration → listeners/resolvers.
  - Normalized docs to ASCII-only, aligned bullet/style conventions, added config-placement notes and inline examples for cache/sequence/concurrent/filter/dns64/recursive docs, refreshed dnsmasqConf guidance, and clarified default behaviors for non-Go readers.
  - Added llm-agent/config_guidance.yaml for LLM-led config generation; removed outdated sample config-google-doh-cached.json.
  - Added unit tests across resolvers (alias, sequence, dns64, doh, nameserver, filter variants, noAnswer, notExist), cache prefetch, HTTP API, and rule provider descriptors.
  - Converted llm-agent common-issues JSON into numbered Markdown todos for triage.
  - Recursive resolver hardened: adds DS→DNSKEY chain validation to root anchors, NSEC/NSEC3 coverage for NXDOMAIN/NODATA, AD gating with strict/permissive policies, SOCKS5/bind-address support, ECS propagation with add/override/strip, and unit tests with signed fixtures. Defaults to embedded root hints when `rootServers` omitted; falls back to TCP on UDP errors.
  - DNSSEC validation now enforces RRSIG timing, verifies DS/DNSKEY chains, and checks NSEC/NSEC3 coverage (strict vs permissive). Default remains permissive; strict fails on validation errors.
  - Added ECS wrapper resolver (add/override/strip) to reuse caches across ECS variants and documented resolver ordering; resolver list alphabetized.
  - Documented ECS strip availability for nameServer/DoH and aligned ECS wrapper naming with its directory.

testing:
  status: "`go test -mod=readonly ./...` passing (2025-12-06)."
  coverage: Unit-heavy for cache/resolvers/rule providers; limited integration/e2e coverage.
  notes: Core/pkg packages still mostly lack tests; long-running cache tests are short (<1s) after recent changes.

documentation:
  key_files:
    - README.md (overview + navigation)
    - docs/configuration.md (global config schema)
    - docs/listeners.md + docs/listeners/http_api_server.md
    - docs/resolvers.md + resolver-specific docs (cache, doh, nameserver, dns64, filters, etc.)
    - docs/rules.md + docs/rules/collection.md + docs/rules/dnsmasq_conf.md
    - docs/version_history.md (current through v1.3.7 after adding release notes; earlier misread as stale)
    - llm-agent/config_guidance.yaml (LLM-facing config generation prompts)
  notes: Docs are ASCII-only with consistent bullet/heading style; cache docs clarify numeric-string acceptance and SOA TTL preference for negative caching; resolver pages now include config placement notes and inline/named examples; dnsmasqConf rule docs describe config.json placement and duplicate handling.

findings:
  - v1.3.7 tag was initially pushed before adding release notes; tag was removed, notes added, and tag re-pushed.
  - docs/version_history.md was briefly misread as stale; confirmed current and updated with v1.3.7 entry.
  - Remember to update docs/version_history.md before creating new version tags.
  - If a tag is pushed prematurely, delete the remote tag before re-tagging after docs/tests are updated.
  - When adding new config fields (e.g., concurrency knobs), update descriptors, docs, and any shipped prod configs together.

current_state:
  repo_status: go test clean; working tree on master with untracked artifacts (.idea/, binaries); config-google-doh-cached.json removed; former feature branch deleted.
  binaries: prebuilt secDNS-* artifacts at repo root.
  config_samples: config.json/config-test*.json in root.
  tooling: go.mod uses module github.com/zhouchenh/secDNS; vendored deps present.

known_gaps:
  - Limited integration/e2e tests for full listener→resolver chains and HTTP API flows; recursive resolver lacks on-wire integration coverage.
  - pkg-level interfaces lack unit coverage.
  - code-inspection-result-20251127/ remains as backlog reference; ensure warnings stay resolved when editing.
  - Operational risk themes (from retired common-issues and reports): concurrency (buffer ownership, ticker leaks, worker pool starvation, async retry storms), memory (alloc pressure, unbounded stats maps/cache growth), DNS protocol correctness (EDNS0 size mismatch, case-insensitive keys, negative caching TTLs, NXDOMAIN vs NODATA), network I/O (FD exhaustion, UDP buffer sizing, address handling, SO_REUSEPORT gaps), error handling/observability (swallowed errors, lack of tracing/health checks), security (open resolver abuse, cache poisoning, AXFR exposure), performance (logging on hot path, reflection in hot paths), resilience (retry storms, non-atomic reloads, no warm-up), and configuration/deployment/testing gaps (time unit parsing, ACLs, pprof exposure, missing fuzz/load/interop/soak tests).
  - Descriptor validation currently falls back to defaults silently when a value is present but invalid; add warnings/logging when a filler rejects an invalid value and the next source is used.

llm_agent_notes:
  - Register new listeners/resolvers/providers in internal/features/features.go.
  - Follow descriptor pattern; numeric configs should accept number or numeric string with sane defaults.
  - Keep docs consistent with existing style and navigation paths.
  - Preserve AGPLv3 headers where applicable; avoid deleting user edits.
  - Default test command: `go test -mod=readonly ./...`.
  - Quick runbook (using release binaries): `./secDNS -test -config config.json`; `./secDNS -config config.json`.
  - High-priority fixes (from IMPROVEMENTS_ANALYSIS.md): tighten cache get() locking, include ECS/EDNS0 in cache keys, close files in dnsmasqConf provider, add nil-resolver guard in cache init; later: request coalescing, faster cleanup, configurable default TTLs, stale-while-revalidate/prefetch tuning.
  - Archived artifacts: `llm-agent/common-issues` and `llm-agent/reports` removed; risk themes and report findings are summarized here.
  - Root analysis markdowns (architecture, cache guides, improvements, overflow) removed; their key guidance is captured here and in README/docs.
  - Distilled architecture patterns (from retired analyses): always check/decrement depth, never mutate caller query (copy or restore), copy responses before caching, release locks before slow ops, use sync.Once for init and RWMutex for hot paths, register resolvers via descriptor init(), resolver references may be named or inline, cache keys must incorporate ECS/EDNS as needed.
  - Caching notes: LRU with TTL overrides, negative caching, optional stale-while-revalidate/prefetch; AccessCount should be uint64 to avoid overflow; consider request coalescing and heap-based cleanup; configurable defaults (min/max/default TTLs, jitter); include cache warming option if added.
  - Design risks to watch: race in cache get/remove window, missing ECS in cache key, fd leak in dnsmasqConf provider, locking scope in cleanup, popular-domain prefetch jitter to avoid thundering herd, avoid goroutine floods in error handling.

contacts:
  repo: https://github.com/zhouchenh/secDNS (inferred)
  license: AGPLv3
